// COPYRIGHT 2009 - CitrusMediaGroup - All Rights Reserved
Mootils.FormAction=new Class({Implements:[Options,Events],options:{requestOptions:null,loaderOptions:null,params:null},initialize:function(form,options){this.form=$(form);this.setOptions(options);if(this.options.fields){if(typeof(Mootils.Validator)==='undefined'){Debug.trace('Required extension \'Mootils.Validator\' not found..');return false;}}
if(this.options.loaderOptions){if(typeof(Mootils.NetStatus)==='undefined'){Debug.trace('Required extension \'Mootils.NetStatus\' not found..');return false;}}
if($type(this.options.onValid)==='function'){this.addEvent('valid',this.options.onValid);}
if($type(this.options.onInvalid)==='function'){this.addEvent('invalid',this.options.onInvalid);}
this.form.addEvent('submit',this.handleSubmit.bind(this));},reset:function(){Mootils.Validator.reset();for(var i=0,l=this.options.fields.length;i<l;i++){$(this.options.fields[i].id).set('value','');}
return this;},checkValid:function(){Mootils.Validator.reset();var id,el,type;var i=this.options.fields.length;while(i--){id=this.options.fields[i].id;el=$(id);type=this.options.fields[i].type||'text';if(this.options.fields[i].required){if(Mootils.Validator.checkValid(id,type))this.addParam(id,type);}else this.addParam(id,type);}
return Mootils.Validator.isValid();},addParam:function(id,type){if(!id)return this;if(!this.params)this.params=new Hash(this.options.params);var val,el=$(id);switch(type){case'timestamp':val=new Date().toString(Date.dbFormat);break;case'checkbox':val=el?(el.get('checked')?1:0):null;break;default:val=el?Mootils.encode(el.get('value')):null;}
this.params[id]=val;return this;},setup:function(){this.options.requestOptions.url=this.options.requestOptions.url||this.form.get('action');this.options.requestOptions.method='post';if(this.options.loaderOptions)this.loader=this.loader||new Mootils.NetStatus(this.options.loaderOptions);this.request=new Request.JSON(this.options.requestOptions);return this;},send:function(){if(this.loader)this.loader.start();this.request.addEvent('complete',this.handleComplete.bind(this));this.request.send('param_str='+JSON.encode(this.params));return this;},cancel:function(){if(this.request)this.request.removeEvents().cancel();if(this.loader)this.loader.hide();return this;},handleComplete:function(evt){if(this.loader)this.loader.hide();},handleSubmit:function(evt){evt=new Event(evt).stop();if(this.checkValid()){this.fireEvent('valid');this.setup().send();}else this.fireEvent('invalid');}});